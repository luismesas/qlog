/*! Iris - v0.5.0 - 2013-02-07
* http://iris-js.github.com/iris
* Copyright (c) 2013 Iris; Licensed New-BSD */
var iris={};window.iris=iris,function(e){function n(){t={},iris.on("iris-reset",n)}function r(e,t){for(var n=0;n<t.length;n++)if(t[n]===e)return n;return-1}var t;iris.on=function(e,n){t.hasOwnProperty(e)||(t[e]=[]);var i=t[e],s=r(n,i);s===-1&&i.push(n)},iris.off=function(e,n){if(t.hasOwnProperty(e))if(n!==undefined){var i=r(n,t[e]);i!==-1&&t[e].splice(i,1)}else delete t[e]},iris.notify=function(e,n){if(e===undefined)throw"[notify] event name parameter is not defined";if(t[e]){var r=t[e];for(var i=0;i<r.length;i++)r[i](n)}},iris.destroyEvents=function(e,n){var i=t[e].concat([]);for(var s=0;s<n.length;s++){var o=r(n[s],i);o!==-1&&i.splice(o,1)}t[e]=i},iris.Event=function(){this.events={}};var i=iris.Event.prototype;i.on=function(e,t){this.events.hasOwnProperty(e)||(this.events[e]=[]);var n=this.events[e],i=r(t,n);i===-1&&(n.push(t),iris.on(e,t))},i.off=function(e,t){var n=this.events[e];if(n){var i=r(t,n);i!==-1&&n.splice(i,1)}},i.notify=function(e,t){iris.notify(e,t)},iris.BEFORE_NAVIGATION="iris_before_navigation",iris.AFTER_NAVIGATION="iris_after_navigation",iris.RESOURCE_ERROR="iris_resource_error",n()}(jQuery),function(e){function u(){if(typeof jQuery=="undefined")throw"jQuery "+t+"+ previous load required";if(e().jquery<t)throw"jQuery "+e().jquery+" currently loaded, jQuery "+t+"+ required";s=window.console&&window.console.log;var n=a("localhost","127.0.0.1");o=n,r=!n,iris.on("iris-reset",u)}function a(e){for(var t=0;t<e.length;t++)if(document.location.href.indexOf(e[t])>-1)return!0;return!1}var t=1.5,n,r,i,s,o;iris.baseUri=function(e){if(e!==undefined)n=e;else if(n===undefined){var t=document.getElementsByTagName("base");t=t.length>0?t[0].attributes.href.value:"/",n=document.location.protocol+"//"+document.location.host+t}return n},iris.cache=function(e){if(e===undefined)return r;r=e},iris.cacheVersion=function(e){if(e===undefined)return i;i=e},iris.log=function(){s&&o&&window.console.log("[iris]",arguments[0],arguments[1],arguments[2],arguments[3])},iris.enableLog=function(){if(!(arguments.length>0))return o;o=a(arguments)},iris.noCache=function(){if(!(arguments.length>0))return!r;r=!a(arguments)},u()}(jQuery),function(e){function n(){t={}}function r(n,r){iris.log("[translations]",n,r),iris.locale()===undefined&&iris.locale(n),t.hasOwnProperty(n)||(t[n]={}),e.extend(t[n],r)}function i(e,t,n){iris.log("[translations]",e,t);var i={url:t,dataType:"json",async:!1,cache:iris.cache()};iris.cache()&&iris.cacheVersion()&&(i.data="_="+iris.cacheVersion()),iris.ajax(i).done(function(t){r(e,t),iris.log("[translations]",t),n&&n.hasOwnProperty("success")&&n.success(e)}).fail(function(r){throw n&&n.hasOwnProperty("error")&&n.error(e),"Error "+r.status+" loading lang file["+t+"]"})}var t;iris.translations=function(e,t,n){typeof t=="object"?r(e,t):i(e,t,n)},iris.translate=function(e,n){var r,i=null;n!==undefined?i=n:i=iris.locale();var s="[translate]";return t.hasOwnProperty(i)?(r=iris.val(t[i],e),r===undefined&&iris.log(s+" label '"+e+"' not found in Locale '"+i+"'",t[i]),typeof r=="object"&&iris.log(s+"label '"+e+"' is an object but must be a property in Locale '"+i+"'",t[i])):iris.log(s+" locale '"+i+"' not loaded",this),r?r:"??"+e+"??"},n()}(jQuery),function(){function n(){e=undefined,t={},iris.on("iris-reset",n)}var e,t;iris.locale=function(n,r){if(typeof r=="object")t[n]||(t[n]={}),$.extend(t[n],r),e===undefined&&(e=n);else{if(n===undefined)return e;e=n}},iris.regional=function(n){if(t.hasOwnProperty(e))return typeof n=="undefined"?t[e]:t[e].hasOwnProperty(n)?t[e][n]:undefined;throw"[regional] for locale '"+e+"' not found"},n()}(),function(e){function t(e){return e<10?"0"+e:e}function n(e,n){var r=iris.regional();switch(e){case"y":return String(n.getFullYear()).substring(2);case"Y":return n.getFullYear();case"m":var i=n.getMonth()+1;return t(i);case"n":return n.getMonth()+1;case"M":return r.monthNames[n.getMonth()].substring(0,3);case"b":return r.monthNames[n.getMonth()].substring(0,3).toLowerCase();case"F":return r.monthNames[n.getMonth()];case"d":var s=n.getDate();return t(s);case"D":return r.dayNames[n.getDay()].substring(0,3);case"l":return r.dayNames[n.getDay()];case"s":var o=n.getSeconds();return t(o);case"i":var u=n.getMinutes();return t(u);case"H":var a=n.getHours();return t(a);case"h":var f=n.getHours();return f=f%12===0?12:f%12,t(f);case"a":return n.getHours()>12?"p.m.":"a.m.";case"A":return n.getHours()>12?"PM":"AM";case"U":return Math.floor(n.getTime()*.001);default:return e}}iris.date=function(e,t){if(e===null)return"";t||(t=iris.regional("dateFormat")),typeof e!="object"&&(e=new Date(e));var r="";for(var i=0,s=t.length;i<s;i++)r+=n(t[i],e);return r},iris.ajax=function(t){return e.ajax(t)},iris.currency=function(t,n){var r={formatPos:"sn",formatNeg:"(sn)",symbol:"$"};e.extend(r,iris.regional("currency"),n);var i=iris.number(t,r);return i.replace("s",r.symbol)},iris.number=function(t,n){var r={formatPos:"n",formatNeg:"- n",decimal:".",thousand:",",precision:2};e.extend(r,iris.regional("number"),n);var i=Number(t),s=i>=0?r.formatPos:r.formatNeg,o=i%1,u=String(Math.abs(i-o));if(r.precision===0)u=parseInt(i.toFixed(),10);else{o=String(Math.abs(o).toFixed(r.precision)),o=o.substr(2);for(var a=0;a<Math.floor((u.length-(1+a))/3);a++)u=u.substring(0,u.length-(4*a+3))+r.thousand+u.substring(u.length-(4*a+3));u=u+r.decimal+o}return s.replace("n",u)},iris.val=function(e,t){var n;if(t.indexOf(".")>-1){var r=t.split("."),i,s=r.length;for(i=0;i<s;i++){if(e===undefined)break;e=e[r[i]]}n=e}else n=e[t];return n}}(jQuery),function(e){function y(){n={},r={},t={},i={},s=undefined,u={},a=!1,f=!1,l="",e(window).off("hashchange"),document.location.hash="#",p=0,d=[],v={},g=[],iris.on("iris-reset",y)}function b(t){if(a===!0)throw"the welcome screen already exists";a=!0,n["#"]=t,r["#"]=e(document.body),window.console&&window.console.log&&window.console.log("[iris] noCache["+iris.noCache()+"] enableLog["+iris.enableLog()+"]"),iris.hasOwnProperty("path")&&w(iris.path),g.length>0?S(g,E):E()}function w(e){if(typeof e=="string")u.hasOwnProperty(e)||g.push(e);else for(var t in e)w(e[t])}function E(){if(!("onhashchange"in window))throw"hashchange event unsupported";k(),e(window).on("hashchange",k)}function S(e,t){iris.log("[load-js]",e),h=t;var n,r;for(var i=0;i<e.length;i++)u.hasOwnProperty(e[i])||(p++,n=String(iris.baseUri()+e[i]),iris.cache()?iris.cacheVersion()&&(n+="?_="+iris.cacheVersion()):n+="?_="+(new Date).getTime(),/.html$/.test(e[i])?iris.ajax({url:n,dataType:"html",async:!0,componentPath:e[i]}).done(T):(r=document.createElement("script"),r.type="text/javascript",r.src=n,r.onload=N,r.onreadystatechange=x,c.appendChild(r)))}function x(){this.readyState==="loaded"&&N()}function T(e,t,n){u[this.componentPath]=e,N()}function N(){--p===0&&h()}function C(e){document.location.hash=e}function k(e){if(!a)throw"set the first screen using iris.welcome()";var n=document.location.hash;n===""&&(n="#");if(l===n)return!1;if(f)return f=!1,iris.notify(iris.AFTER_NAVIGATION),l=o,!1;iris.log("Starting a new navigation["+n+"]"),l=n,iris.notify(iris.BEFORE_NAVIGATION);var i,u,c=-1,h=n.split("/"),p;if(s!==undefined){for(i=0;i<h.length;i++)if(s[i]===undefined||s[i]!==h[i]){c=i;break}p=c,p===-1&&h.length<s.length?p=h.length:c===0&&s.length===1&&(p=-1),h.length===1&&c===-1&&(c=1);if(p!==-1){for(i=s.length-1;i>=p;i--){u=M(s,i);if(t[u].canSleep()===!1)return f=!0,document.location.href=o,!1}for(i=s.length-1;i>=p;i--){var d=t[M(s,i)];d._sleep(),d.hide()}}}else c=0;if(c!==-1)for(i=c;i<h.length;i++){u=M(h,i);if(!r.hasOwnProperty(u))throw"'"+u+"' must be registered using self.screens()";if(!t.hasOwnProperty(u)){var v=F(u);v.create(),t[u]=v}var m=t[u],g=O(h[i]);m._awake(g),m.show()}s=h,o=n,iris.log("Navigation finished"),iris.notify(iris.AFTER_NAVIGATION)}function L(e){return A(e.replace(/\?[^\/]*/,""))}function A(e){return e.replace(/\/$/,"")}function O(e){var t={},n=/([\.\w_\-]*)=([^&]*)/g,r=n.exec(e);while(r)t[r[1]]=decodeURIComponent(r[2]),r=n.exec(e);return t}function M(e,t){var n="";for(var r=0;r<=t;r++)n+="/"+L(e[r]);return n.substr(1)}function _(e){var t=e,n=t.match(/@@[A-Za-z_\.]+@@/g);if(n){var r,i=n.length;for(r=0;r<i;r++)t=t.replace(n[r],iris.translate(n[r].substring(2,n[r].length-2)))}return t}function D(e,t){u[e]=t}function P(e,t){u[t]=e}function H(t,n,r,i,s){var o=new W;o.id=n,o.uis=[],o.el={},o.events={},o.con=t,o.fileJs=r,u[r](o),s!==undefined&&(o._tmplMode=s),i=i===undefined?{}:i;var a=B(t);return o.cfg===null&&(o.cfg={}),e.extend(o.cfg,a,i),o.create(a,i),o._awake(),o}function B(e){var t={},n=e.get(0).attributes,r;for(var i=0,s=n.length;i<s;i++)r=n[i].name,r.indexOf("data-")===0&&(r=r.substr(5)),t[r]=n[i].value;return t}function j(e,t){u[t]=e}function F(e){var i=n[e],s=new X;return u[i](s),s.id=e,s.el={},s.uis=[],s.events={},s.con=r[e],s.fileJs=i,s.cfg===null&&(s.cfg={}),t[e]=s,s}function I(e){if(t.hasOwnProperty(e)){if(e==="#")throw"Welcome screen cannot be deleted";var n=document.location.hash;if(n!=="#"&&n!==""&&(e.indexOf(n)===0||n.indexOf(e)===0))throw"Cannot delete the current screen or its parents";q(e)}else iris.log('Error removing the screen "'+e+'", path not found.')}function q(e){var s=t[e];if(s!==undefined){if(s.screenChilds!==undefined)for(var o=0;o<s.screenChilds.length;o++)q(s.screenChilds[o]);s._destroy(),s.get().remove(),delete i[n[e]],delete t[e],delete n[e],delete r[e]}}function R(e,t,n){var r=e,i,s,o=/##([0-9A-Za-z_\.]+)(?:\|(date|currency)(?:\(([^\)]+)\))*)?##/g,u=o.exec(e);while(u){s=iris.val(t,u[1]);if(s!==undefined){i=u[2];if(i)switch(i){case"date":s=iris.date(s,u[3]);break;case"currency":s=iris.currency(s);break;default:iris.log("Unknow template format label '"+i+"' in '"+n+"'")}}else iris.log("Template param '"+u[1]+"' in '"+n+"' not found",t);r=r.replace(u[0],s),u=o.exec(e)}return r}function V(e,t){if(typeof e=="string"){if(!u.hasOwnProperty(e))throw"add service["+e+"] to iris.path";return u[e]}var n=new iris.Resource;n.cfg={},n.settings({type:"json",path:""}),e(n),u[t]=n}var t,n,r,i,s,o,u,a,f,l,c=document.getElementsByTagName("head")[0],h,p,d,v,m,g,U=function(){this.cfg=null};U.prototype=new iris.Event,U.prototype.settings=function(t){return this.cfg===null&&(this.cfg={}),e.extend(this.cfg,t)},U.prototype.setting=function(e,t){if(t===undefined)return this.cfg.hasOwnProperty(e)||iris.log("setting "+e+" not found",this.cfg,this),this.cfg[e];this.cfg[e]=t};var z=function(){this.APPEND="append",this.REPLACE="replace",this.PREPEND="prepend",this.id=null,this.fileJs=null,this.fileTmpl=null,this.template=null,this.uis=null,this.con=null,this.sleeping=null,this.el=null,this.events=null};z.prototype=new U,z.prototype._sleep=function(){for(var e=0,t=this.uis.length;e<t;e++)this.uis[e]._sleep();this.sleeping=!0,this.sleep()},z.prototype._awake=function(e){this.sleeping=!1,this.awake(e);for(var t=0,n=this.uis.length;t<n;t++)this.uis[t].sleeping!==!1&&this.uis[t]._awake()},z.prototype._destroy=function(){this.sleeping||this._sleep();for(var e=0,t=this.uis.length;e<t;e++)this.uis[e]._destroy();for(var n in this.events)iris.destroyEvents(n,this.events[n]);this.destroy(),this.uis=null,this.events=null},z.prototype._tmpl=function(t,n,r){if(this.template!==null)throw"self.tmpl() has already been called in '"+this.fileJs+"'";this.fileTmpl=t;var i=_(u[t]),s=n?R(i,n,t):i,o=e(s);this.template=o;if(o.size()>1)throw"'"+t+"' must have only one root node";switch(r){case this.APPEND:this.con.append(o);break;case this.REPLACE:this.con.replaceWith(o),this.con={selector:this.con.selector};break;case this.PREPEND:this.con.prepend(o);break;default:throw"Unknown template mode '"+r+"'"}this.model={};var a=this.model;e("[data-model]",o).each(function(){var t=e(this),n=t.data("model");a.hasOwnProperty(n)||(a[n]=[]),a[n].push(t)})},z.prototype.inflate=function(e){if(this.model===undefined)throw"[self.inflate] first set a html node with any data-model attribute";var t,n,r,i,s,o,u,a,f,l=/(date|currency)(?:\(([^\)]+)\))/;for(t in this.model){n=iris.val(e,t);if(n!==undefined){r=this.model[t],a=undefined;for(s=0;s<r.length;s++){u=r[s],o=u.data("format"),o&&l.test(o)&&(f=o.match(l),o=f[1],a=f[2]);if(o)switch(o){case"date":n=iris.date(n,a);break;case"currency":n=iris.currency(n)}i=u.prop("nodeName").toLowerCase(),i==="input"||i==="textarea"?u.val(n):u.text(n)}}}},z.prototype._checkTmpl=function(){if(this.template===null)throw"Set a template using self.tmpl() in '"+this.fileJs+"'"},z.prototype.show=function(){this._checkTmpl(),this.template.show()},z.prototype.hide=function(){this._checkTmpl(),this.template.hide()},z.prototype.get=function(e){this._checkTmpl();if(e){if(!this.el.hasOwnProperty(e)){var t="[data-id="+e+"]",n=this.template.filter(t),r=null;if(n.length>0)r=n;else{var i=this.template.find(t);i.size()>0&&(r=i)}if(r===null)throw"[data-id="+e+"] not found in '"+this.fileTmpl+"' used by '"+this.fileJs+"'";if(r.size()>1)throw"[data-id="+e+"] must be unique in '"+this.fileTmpl+"' used by '"+this.fileJs+"'";this.el[e]=r}return this.el[e]}return this.template},z.prototype._ui=function(e,t,n,r){var i=this.get(e);if(i!==undefined&&i.size()===1){var s=H(i,i.data("id"),t,n,r);if(s._tmplMode===undefined||s._tmplMode===s.REPLACE)this.el[e]=undefined;return this.uis[this.uis.length]=s,s}throw"The container does not exist or has been replaced."},z.prototype.destroyUI=function(e){for(var t=0,n=this.uis.length;t<n;t++)if(this.uis[t]===e){this.uis.splice(t,1),e._destroy(),e.get().remove();break}},z.prototype.destroyUIs=function(e){var t=typeof e=="string"?"[data-id="+e+"]":e.selector,n;for(var r=0,i=this.uis.length;r<i;r++){n=this.uis[r];if(n.con.selector.indexOf(t)!==-1){if(n._tmplMode===this.REPLACE)throw"self.destroyUIs cannot delete "+t+" because was replaced by an UI, use self.destroyUI";this.uis.splice(r--,1),i--,n._destroy(),n.get().remove()}}},z.prototype.container=function(){return this.con},z.prototype.create=function(){},z.prototype.awake=function(){},z.prototype.canSleep=function(){return!0},z.prototype.sleep=function(){},z.prototype.destroy=function(){};var W=function(){this._tmplMode="replace"};W.prototype=new z,W.prototype.tmplMode=function(e){this._tmplMode=e},W.prototype.tmpl=function(e,t){this._tmpl(e,t,this._tmplMode)},W.prototype.ui=function(e,t,n,r){return this._ui(e,t,n,r)};var X=function(){this.screenConId=null};X.prototype=new z,X.prototype.ui=function(e,t,n,r){if(e===this.screenConId)throw"'"+e+"' has already been registered as a screen container";return this._ui(e,t,n,r)},X.prototype.tmpl=function(e,t){this._tmpl(e,t,this.APPEND)},X.prototype.screens=function(e,t){this.screenConId=e;if(this.hasOwnProperty("screenChilds"))throw"Multiple calls to self.screens() are not allowed: "+this.id;if(this.template===null)throw"self.tmpl() must be called before self.screens(): "+this.id;var s=this.get(e);this.screenChilds=[];for(var o=0;o<t.length;o++){var u=t[o],a=u[0];if(a.indexOf("#")!==-1)throw"[self.screens] incorrect screen path["+a+"] cannot contain #";a=this.id+"/"+a;var f=u[1];if(i.hasOwnProperty(f))throw"[self.screens] js-URL repeated '"+f+"': "+this.id;if(r.hasOwnProperty(a))throw"[self.screens] hash-URL repeated  '"+a+"' in "+this.fileJs;iris.log("Register screen hash["+a+"] js["+f+"]"),n[a]=f,r[a]=s,i[f]=!0,this.screenChilds[o]=a}},iris.screen=j,iris.destroyScreen=I,iris.welcome=b,iris.navigate=C,iris.ui=P,iris.tmpl=D,iris.resource=V,iris.Settable=U,iris.Component=z,iris.UI=W,iris.Screen=X,y()}(jQuery),function(){var e=function(){};e.prototype=new iris.Settable,e.prototype.ajax=function(e,t,n,r,i){return iris.ajax({url:this.setting("path")+t,type:e,data:n,cache:!1,dataType:this.setting("type"),async:!0,success:r,error:function(e,t,n){iris.notify(iris.RESOURCE_ERROR,{request:e,status:t,error:n}),i!==undefined&&i()}})},e.prototype.get=function(e,t,n){return this.ajax("GET",e,null,t,n)},e.prototype.del=function(e,t,n){return this.ajax("DELETE",e,null,t,n)},e.prototype.put=function(e,t,n,r){return this.ajax("PUT",e,t,n,r)},e.prototype.post=function(e,t,n,r){return this.ajax("POST",e,t,n,r)},iris.Resource=e}();